<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<link rel="stylesheet" href="styles.css">
<div id="sisältö">
    <h1>Kurssihaku</h1>

    <form>
        <div class="Row">
            <!--<div class="float-left">
                <h3>Aihe</h3>
            <div class="selectBox" onclick="showCheckboxes1(this)">
                <select>
                  <option>Valitse</option>
                </select>
                <div class="overSelect"></div>
              </div>
              <div  class="multipleSelect" name="aihe" class="aihe">-->
                <!-- tähän koulut sivun lataamisen yhteydessä  -->
              <!--</div>
            </div>-->
            <div class="float-left">
                <h3>Aihe</h3>
                <select name="aihe" id="aihe" class="aihe">
                    <!--  Tähän geneeriset osa-alueet sivun lataamisen yhteydessä -->
                </select>
            </div>

            <div class="float-left">
                <h3>Korkeakoulu</h3>
            <div class="selectBox">
                <select>
                  <option>Kaikki</option>
                </select>
                <div class="overSelect"></div>
                <div  class="multipleSelect koulu" name="koulu" id="checkboxes1">
                    <!-- tähän koulut sivun lataamisen yhteydessä  -->
                  </div>
              </div>
              
            </div>
            <!--<div class="float-left">
                <h3>Korkeakoulu</h3>
                <select name="koulu" id="koulu">-->
                    <!-- tähän koulut sivun lataamisen yhteydessä  -->
               <!-- </select>
            </div>-->
            <!--<div class="float-left">
                <h3>Opetuskieli</h3>
            <div class="selectBox" onclick="showCheckboxes1(this)">
                <select>
                  <option>Valitse</option>
                </select>
                <div class="overSelect"></div>
                <div class="multipleSelect">
                    <label for="one">
                      <input type="checkbox" id="one" />Suomi</label>
                    <label for="two">
                      <input type="checkbox" id="two" />Ruotsi</label>
                    <label for="three">
                      <input type="checkbox" id="three" />Englanti</label>
                  </div>
              </div>
              
            </div>-->
            <div class="float-left">
                <h3>Opetuskieli</h3>
                <select name="kieli" id="kieli">
                    <option value="koulu1">Suomi </option>
                    <option value="koulu2">Ruotsi</option>
                    <option value="koulu3">Englanti</option>
                </select>
            </div>
        </div>

        <br><br>

        <div class="nappiKeskelle">
            <input id="haeNappi" class="myButton" type="button" value="HAE OPINNOT">
        </div>

        <h2>Löydetyt opintojaksot</h2>

        <table id="data">
            <thead>
                <tr>
                    <th>Nro</th>
                    <th>Opintojakson nimi</th>
                    <th>Oppilaitos</th>
                    <th>Opetuskieli</th>
                    <th>Opintopisteet</th>
                </tr>
            </thead>

            <tbody id="tbody">
                <!-- tbody:yn haetaan kurssit-->

            </tbody>

        </table>

    </form>

</div>

<style>

.selectBox {
  position:relative; 
}

.selectBox select {
  width: 100%;
}

.overSelect {
  position:absolute;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
}

#checkboxes1 {
  display:none;
  border: 1px #dadada solid;
  background-color: white;
  position:absolute;
  font-size: 1.5rem;
  width: 100%;
  height: 10em;
  overflow-y: scroll;
  z-index: 1;
}

  #checkboxes1 label input {
  margin-right: 1em;
  width: 1.5em;
  height: 1.5em;
  }

#checkboxes1 label {
  display: block;
  margin-top: 1%;
}

#checkboxes1 label:hover {
  background-color: #1e90ff;
  color: white;
}
</style>

<script>
    // tietokannasta otettava korkeakoulut valikkoon (heti kun sivu latautuu!)
    // samoin geneeriset osa-alueet? kielet?
    var genOsaamiset = null;
    var koulut = null;
    var avattu = false;
    var valittu = true;

    $(document).ready(function () {

        document.addEventListener("click", function(e){
            console.log(e.target);
            if(e.target && (e.target.matches(".overSelect") || e.target.matches(".koulu *"))){
                if(avattu){
                    document.querySelector(".koulu").style.display = "none";
                    avattu = false;
                }
                else{
                    document.querySelector(".koulu").style.display = "block";
                    avattu = true;
                }
            }
            else{
                document.querySelector(".koulu").style.display = "none";
                avattu = false;
            }
        });

        $(".koulu").on("click", "#kaikki", function() {
            console.log("moi");
            var x = document.querySelectorAll(".checkboxKoulut");
            for (var i of x){
                if(valittu){
                    i.checked = false;
                }
                else{
                    i.checked = true;
                }
            }
            
            if(valittu){
                valittu = false;
            }
            else{
                valittu = true;
            }
        })

        //haetaan aiheet valikkoon:
        $.get("http://127.0.0.1:5000/api/rajapinnat", function (data) {
            genOsaamiset = $.extend({}, { "Kaikki": "/api/" }, data);
            var genOsaamiset_select = document.querySelector(".aihe")
            var html = ``
            for (var i in genOsaamiset) {
                var option = `<option value="${i}">${i}</option>`
                html += option
            }
            genOsaamiset_select.innerHTML = html
        })

        //haetaan koulut valikkoon:
        $.get("http://127.0.0.1:5000/api/koulut", function (data) {
             koulut = data;
            var korkeaKoulu_select = document.querySelector(".koulu")
            var html = `<label><input type="checkbox" checked id="kaikki"/>Kaikki / Tyhjennä</label>`
            for (var i in koulut) {
                var option = `<label><input class="checkboxKoulut" type="checkbox" checked value="${koulut[i].koulu}"/>${koulut[i].koulu}</label>` /*`<option value="${koulut[i].koulu}">${koulut[i].koulu}</option>`*/ 
                html += option
            }
            korkeaKoulu_select.innerHTML = html;
        })

        //otetaan kiinni aihe mikä on valittu:
        $('#haeNappi').click(() => {
            var geneerinenAlue = document.getElementsByClassName("aihe");
            var aihe = geneerinenAlue.options[geneerinenAlue.selectedIndex].value; //antaa esim. "aihe5" eli Tutkimus...
            fetch(aihe);
        });

        fetch = (aihe) => {
            console.log(aihe);
            var valinta = "";
            if (aihe == "Kaikki") {
                valinta = "kaikki";
            }
            if (aihe == "Asiakaslähtöisyys") {
                valinta = "asiakaslahtoisyys";
            }
            if (aihe == "Kestävän kehityksen osaaminen") {
                valinta = "kestavakehitys";
            }
            if (aihe == "Lainsäädäntö ja etiikka") {
                valinta = "etiikka";
            }
            if (aihe == "Monialainen yhteistoiminta") {
                valinta = "yhteistoiminta";
            }
            if (aihe == "Neuvontaosaaminen") {
                valinta = "neuvontaosaaminen";
            }
            if (aihe == "Palvelujärjestelmät") {
                valinta = "palvelujarjestelmat";
            }
            if (aihe == "Robotiikka ja digitalisaatio") {
                valinta = "robotiikka";
            }
            if (aihe == "Tutkimus- ja kehittämisosaaminen") {
                valinta = "tutkimusosaaminen";
            }
            if (aihe == "Työntekijyysosaaminen") {
                valinta = "tyontekijyysosaaminen";
            }
            if (aihe == "Vaikuttavuus- kustannus- ja laatutietoisuus") {
                valinta = "laatutietoisuus";
            }
            if (aihe == "Viestintäosaaminen") {
                valinta = "viestintaosaaminen";
            }


            console.log(aihe);
            console.log(valinta);
            var osoiteUrl = 'http://127.0.0.1:5000/api/' + valinta;
            $.get({
                url: osoiteUrl,
                success: (result) => {
                    $("#data tbody").html("");
                    showResultInTable(result);
                },
                error: (e) => {
                    alert("Virhe: " + e); //e selkokieliseksi, miten?
                }
            });
        }
        fetch("aihe1");
    });

    //laitetaan tiedot taulukkoon:
    showResultInTable = (result) => {
        var nro = 1;
        result.forEach(element => {
            let opintojaksot = "<tr><td>" + nro + "</td>\n";
            opintojaksot += "<td>" + element.nimi + "</td>\n";   
            opintojaksot += "<td>" + element.koulu + "</td>\n";
            opintojaksot += "<td>" + element.kieli + "</td>\n";
            opintojaksot += "<td>" + element.opintopisteet + "</td>\n";
            opintojaksot += "</tr>\n";
            $("#data tbody").append(opintojaksot);
            nro++;
        });
    }

</script>