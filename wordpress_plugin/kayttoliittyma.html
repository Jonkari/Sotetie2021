<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<link rel="stylesheet" href="styles.css">
<div id="sisältö">
    <h1>KURSSIHAKU</h1>
    <p id="paivitys">Päivämäärä</p>
    <br>
    <br>
    <form>
        <div class="Row">
            <div class="float-left">
                <h3>AIHE</h3>
                <select name="aihe" id="aihe" class="aihe">
                    <!--  Tähän geneeriset osa-alueet sivun lataamisen yhteydessä -->
                </select>
            </div>
            <br>
            <h4>Valitse korkeakoulut erikseen tai valitse maakunta, joka valitsee koulut puolestasi:</h4>

            <div class="flex-container">
                <div class="selectBox">
                    <h3>KORKEAKOULU</h3>
                    <select class="nakyvaMaara"></select>
                    <!--tähän valittujen koulujen numero-->
                    <div class="overSelect"></div>
                    <div class="multipleSelect koulu" name="koulu" id="checkboxes1">
                        <!-- tähän koulut sivun lataamisen yhteydessä  -->
                    </div>
                </div>

                <div class="selectBox" id="selectBoxMaakunta">
                    <h3>MAAKUNTA</h3>
                    <select name="maakunnat" id="maakunnat" class="maakunnat">
                        <!-- tähän maakunnat sivun lataamisen yhteydessä  -->
                    </select>
                    
                </div>
            </div>
            <br>
            <div class="float-left" style="display: flex; flex-flow: column wrap;">
                <div class="radiorivi">
                    <h3>Opetuskieli</h3>
                    <input type="radio" name="kieli" value="suomi" id="suomi" checked>
                    <label for="suomi">Suomi</label> &nbsp;&nbsp;
                    <input type="radio" name="kieli" value="ruotsi" id="ruotsi">
                    <label for="ruotsi">Ruotsi</label> &nbsp;&nbsp;
                    <input type="radio" name="kieli" value="englanti" id="englanti">
                    <label for="englanti">Englanti</label>
                </div>

                <div class="radiorivi">
                    <h3>Opetustapa</h3>
                    <input type="radio" name="tapa" value="kaikkiTavat" id="kaikkiTavat" checked>
                    <label for="kaikkiTavat">Kaikki</label> &nbsp;&nbsp;
                    <input type="radio" name="tapa" value="lahiopetus" id="lahi">
                    <label for="lahi">Lähiopetus</label> &nbsp;&nbsp;
                    <input type="radio" name="tapa" value="etaopetus" id="eta">
                    <label for="eta">Etäopetus</label>
                </div>
            </div>
        </div>

        <br><br>

        <div class="nappiKeskelle">
            <input id="haeNappi" class="myButton" type="button" value="HAE OPINNOT">
        </div>
        <br><br><br>
        <h2 id="eiKursseja">Ei hakuehtoja vastaavia kursseja</h2>
        <h2 id="eiYhteytta">Tietokantaan ei saada yhteyttä. Yritä ladata sivu uudestaan. Jos ei muutaman kerran jälkeen
            kurssihaku onnistu, ota yhteyttä sivuston ylläpitäjään.</h2>

        <section id="kurssiTaulu">
            <h2 id="tauluOtsikko">LÖYDETYT OPINTOJAKSOT</h2>

            <table id="data">
                <thead>
                    <tr>
                        <!--<th colspan="1">Nro</th>-->
                        <th colspan="2">OPINTOJAKSON NIMI</th>
                        <th colspan="2">OPPILAITOS</th>
                        <!--<th colspan="1">Opetuskieli</th>
                    <th colspan="1">Opintopisteet</th>-->
                    </tr>
                </thead>

                <tbody id="tbody">
                    <!-- tbody:yn haetaan kurssit-->

                </tbody>

            </table>
        </section>

    </form>
</div>


<script>

    var genOsaamiset = null;
    var koulut = null;
    var avattu = false;
    var valittu = true;
    var kieli = "suomi";
    var opetustapa = "kaikkiTavat";
    var osoite = "http://137.74.119.216:5000"; //"http://137.74.119.216:5000/"

    // näkyviin ilmoitus, jos tietokantaan ei saada yhteyttä 
    function virheTilanne() {
        document.getElementById("kurssiTaulu").style.display = "none";
        document.getElementById("eiYhteytta").style.display = "block";
    };

    $(document).ready(function () {

        document.addEventListener("click", function (e) {
            if (e.target && (e.target.matches(".overSelect"))) {
                if (avattu) {
                    document.querySelector(".koulu").style.display = "none";
                    avattu = false;
                }
                else {
                    document.querySelector(".koulu").style.display = "block";
                    avattu = true;
                }
            }
            else {
                if (e.target && (e.target.matches(".checkboxKoulut") || e.target.matches('.koulu *'))) {
                } else {
                    document.querySelector(".koulu").style.display = "none";
                    avattu = false;
                }
            }
        });

        $(".koulu").on("click", "#kaikki", function () {
            var x = document.querySelectorAll(".checkboxKoulut");
            for (var i of x) {
                if (valittu) {
                    i.checked = false;
                }
                else {
                    i.checked = true;
                }
            }

            if (valittu) {
                valittu = false;
            }
            else {
                valittu = true;
            }
        })

        function paivitaMaara() {
            var checkboxes = $('input.checkboxKoulut:checked').length;
            var koulut_nro = document.querySelector(".nakyvaMaara")
            var html = ``
            var option = `<option>${checkboxes} koulua valittu</option>`
            html += option
            koulut_nro.innerHTML = html
        }

        //kuinka monta koulua valittu
        $("#checkboxes1").click(function () {
            paivitaMaara();
        })

        //asetetaan muuttujiin kieli ja opetustapa
        $(".radiorivi").click(function () {
            kieli = valittuKieli();
            opetustapa = valittuOpetustapa();
        })

        //mikä kieli valittu
        function valittuKieli() {
            var vaihtoehdot = document.getElementsByName('kieli');
            for (i = 0; i < vaihtoehdot.length; i++) {
                if (vaihtoehdot[i].checked)
                    return vaihtoehdot[i].value;
            }
        }

        //mikä opetustapa valittu
        function valittuOpetustapa() {
            var vaihtoehdot = document.getElementsByName('tapa');
            for (i = 0; i < vaihtoehdot.length; i++) {
                if (vaihtoehdot[i].checked)
                    return vaihtoehdot[i].value;
            }
        }

        //haetaan aiheet valikkoon:
        $.get(osoite + "/api/rajapinnat", function (data) {
            genOsaamiset = $.extend({}, { "Kaikki": "/api/" }, data);
            var genOsaamiset_select = document.querySelector(".aihe")
            var html = ``
            for (var i in genOsaamiset) {
                var option = `<option value="${i}">${i}</option>`
                html += option
            }
            genOsaamiset_select.innerHTML = html
            if(valmisHaku !== undefined) {
                valmisHaku(genOsaamiset)
            }
            fetch(genOsaamiset_select.options[genOsaamiset_select.selectedIndex].value);
        })
            .fail(virheTilanne);
        



        //haetaan koulut valikkoon:
        var maakuntaSet = new Set();
        $.get(osoite + "/api/koulut", function (data) {
            koulut = data;
            var korkeaKoulu_select = document.querySelector(".koulu")
            var html = `<label><input type="checkbox" checked id="kaikki"/>Kaikki / Tyhjennä</label>`
            for (var i in koulut) {
                var option = `<label><input class="checkboxKoulut" type="checkbox" checked value="${koulut[i].koulu}"/>${koulut[i].koulu}</label>` /*`<option value="${koulut[i].koulu}">${koulut[i].koulu}</option>`*/
                html += option
            }
            korkeaKoulu_select.innerHTML = html;
            paivitaMaara();
            maakunnat = data
            var maakunnat_select = document.querySelector(".maakunnat")
            var html = `<option value="kaikki">Kaikki</option>`
            for(var i in maakunnat){
                maakuntaSet.add(maakunnat[i].maakunta);
            }
            maakuntaSet.forEach(function(value){
                var option = `<option value="${value}">${value}</option>`
                html += option
            })
            maakunnat_select.innerHTML = html
        })
        .fail(virheTilanne)




        //Haetaan viimeisimmän päivityksen päivämäärä:
        $.get(osoite + "/api/paivitys", function (data) {
            var paivitys = new Date(data[0].data * 1000);
            var kuukausi = paivitys.getMonth() + 1;
            var paiva = paivitys.getDate();
            var vuosi = paivitys.getFullYear();
            document.getElementById("paivitys").innerHTML = `Päivitetty: ${paiva}.${kuukausi}.${vuosi}`;
        }).fail(virheTilanne)

        //otetaan kiinni aihe mikä on valittu:
        $('#haeNappi').click(() => {
            var geneerinenAlue = document.querySelector(".aihe");
            var aihe = geneerinenAlue.options[geneerinenAlue.selectedIndex].value; //antaa esim. "aihe5" eli Tutkimus...
            fetch(aihe);
        });

        fetch = (aihe) => {
            var osoiteUrl = osoite + genOsaamiset[aihe];
            $.get({
                url: osoiteUrl,
                success: (result) => {
                    $("#data tbody").html("");
                    showResultInTable(result);
                },
                error: (e) => {
                    alert("Virhe: " + e); //e selkokieliseksi, miten? OLIKO TÄLLÄ (error) MERKITYSTÄ, VOIKO OTTAA POIS?
                }
            }).fail(virheTilanne);
        }
    });

    //laitetaan haetut tiedot Löydetyt opintojaksot -tauluun:

    showResultInTable = (result) => {
        var valitut = new Set();
        var checkBoxes = document.querySelectorAll(".checkboxKoulut")

        for (var x of checkBoxes) {
            if (x.checked) {
                valitut.add(x.value)
            }
        }
        var nro = 0;
        html = ``
        
            result.forEach(element => {
                if (valitut.has(element.koulu) && element.kieli == kieli && (opetustapa == "kaikkiTavat" || element.opetustyyppi == opetustapa)) {
                    let opintojaksot = ""
                    //opintojaksot = "<tr><td colspan=\"1\">" + nro + "</td>\n";
                    opintojaksot += `<td colspan="2"><a href="https://opintopolku.fi/app/#!/koulutus/${element.id}">${element.nimi} (${element.opintopisteet} op)</a></td>\n`;
                    opintojaksot += "<td colspan=\"2\">" + element.koulu + "</td>\n";
                    //opintojaksot += "<td colspan=\"1\">" + element.kieli + "</td>\n";
                    //opintojaksot += "<td colspan=\"1\">" + element.opintopisteet + "</td>\n";
                    opintojaksot += "</tr>\n";
                    html += opintojaksot
                    nro++;
                }
            });
                document.getElementById("tauluOtsikko").innerHTML = "Löydetyt opintojaksot (" + nro + " kpl)";
                document.getElementById("kurssiTaulu").style.display = "block";
                document.getElementById("eiKursseja").style.display = "none";
                document.getElementById("eiYhteytta").style.display = "none";
            

        if (html.length == 0) {
            //html += "<h1> Ei tuloksia </h1>";
            document.getElementById("eiKursseja").style.display = "block";
            document.getElementById("kurssiTaulu").style.display = "none";
            document.getElementById("eiYhteytta").style.display = "none";
        }
        document.querySelector("#data tbody").innerHTML = html;
    }

</script>